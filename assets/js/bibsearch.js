import{highlightSearchTerm}from"./highlight-search-term.js";document.addEventListener("DOMContentLoaded",function(){const e=e=>e.toLowerCase().trim().replace(/[^\w\s]/g," ").replace(/\s+/g," "),t=(t,r)=>{if(!r||0===r.length)return!0;if(!t||0===t.length)return!1;const n=e(t),a=e(r);if(n.includes(a))return!0;if(/^\d{4}$/.test(r.trim()))return n.includes(r.trim());if(/^[A-Z]{3,6}$/.test(r.trim()))return n.includes(r.toLowerCase());const i=a.split(" ").filter(e=>e.length>2);return i.length>1?i.every(e=>n.includes(e)):n.split(" ").some(e=>e.includes(a)||a.length>3&&e.length>3&&a.includes(e.substring(0,Math.min(4,e.length))))},r=e=>{const t={title:"",authors:"",abstract:"",categories:"",venue:"",year:""},r=e.querySelector(".title");r&&(t.title=r.textContent||"");const n=e.querySelector(".author");n&&(t.authors=n.textContent||"");const a=e.querySelector(".abstract-text, .abstract");a&&(t.abstract=a.textContent||a.getAttribute("data-full-text")||"");const i=e.querySelectorAll(".badge-category[data-category]");i.length>0&&(t.categories=Array.from(i).map(e=>e.getAttribute("data-category")||"").filter(e=>e.length>0).join(" "));const o=e.querySelector("abbr.badge.rounded");if(o){const e=o.querySelector("a");t.venue=e?e.textContent:o.textContent,t.venue=t.venue.trim()}else{const r=e.querySelectorAll(".periodical");for(const e of r){const r=e.textContent.trim();if(r&&(r.includes("Under Review")||r.includes("under review")||r.includes("arXiv")||r.includes("Review"))){t.venue=r;break}}}const l=e.querySelector(".year-badge");return l&&(t.year=l.textContent.trim()),t.title=t.title.trim(),t.authors=t.authors.trim(),t.abstract=t.abstract.trim(),t.categories=t.categories.trim(),t.venue=t.venue.trim(),t.year=t.year.trim(),console.log("\ud83d\udcca Extracted content:",{title:t.title.substring(0,30)+"...",authors:t.authors.substring(0,30)+"...",categories:t.categories,venue:t.venue,year:t.year,abstract:t.abstract.substring(0,50)+"..."}),t},n=(r,n)=>{if(!n||0===n.trim().length)return!0;const a=e(n),i=/^\d{4}$/.test(n.trim()),o=["cvpr","iccv","eccv","nips","icml","aaai","ijcai","acl","emnlp","naacl","iclr","icdar","wacv","acmm","tmlr","tpami","tog","jov"].includes(n.toLowerCase())||n.toLowerCase().includes("under review")||n.toLowerCase().includes("arxiv")||n.toLowerCase().includes("review")||/^(under\s+review|arxiv|preprint)$/i.test(n.trim());if(i)return t(r.year,n);if(o)return t(r.venue,n);const l=[{name:"categories",content:r.categories,weight:3},{name:"title",content:r.title,weight:2.5},{name:"authors",content:r.authors,weight:2},{name:"venue",content:r.venue,weight:1.5},{name:"year",content:r.year,weight:1.5},{name:"abstract",content:r.abstract,weight:1}];let s=0,c=0,u=[];for(const e of l)c+=e.weight,t(e.content,a)&&(s+=e.weight,u.push(e.name));const d=s/c,h=d>.1;return console.log(`\ud83d\udd0d Search "${n}" in:`,{year:r.year,venue:r.venue,authors:r.authors.substring(0,50)+"...",matchedFields:u,score:d.toFixed(3),passes:h,isYear:i,isVenue:o}),h},a=t=>{if(document.querySelectorAll(".bibliography, .unloaded").forEach(e=>e.classList.remove("unloaded")),!t||0===t.trim().length)return;e(t);let a=0,i=0,o=0;if(console.log(`\ud83d\udd0d Starting search for: "${t}"`),document.querySelectorAll(".bibliography > li").forEach(e=>{a++;const l=r(e);n(l,t)?o++:(e.classList.add("unloaded"),i++)}),console.log(`\ud83d\udcca Search results: ${o}/${a} papers matched, ${i} hidden`),CSS.highlights)highlightSearchTerm({search:t,selector:".bibliography > li:not(.unloaded)"});document.querySelectorAll("h2.bibliography").forEach(function(e){let t=e.nextElementSibling,r=!0;for(;t&&"H2"!==t.tagName;){if("OL"===t.tagName){const e=t,n=e.querySelectorAll(":scope > li.unloaded"),a=e.querySelectorAll(":scope > li");n.length===a.length?(e.previousElementSibling&&e.previousElementSibling.classList.add("unloaded"),e.classList.add("unloaded")):r=!1}t=t.nextElementSibling}r&&e.classList.add("unloaded")})},i=()=>{const e=decodeURIComponent(window.location.hash.substring(1)),t=document.getElementById("bibsearch");if(t){let r=e;e.startsWith("category=")&&(r=e.replace("category=","")),t.value=r,a(r)}};let o;const l=document.getElementById("bibsearch");l&&(l.placeholder="Search papers by title, author, category, venue, or keywords...",l.addEventListener("input",function(){clearTimeout(o);const e=this.value;e.trim().length>0?history.replaceState(null,null,`#${encodeURIComponent(e)}`):history.replaceState(null,null,window.location.pathname),o=setTimeout(()=>a(e),200)}),l.addEventListener("keydown",function(e){"Escape"===e.key&&(this.value="",a(""),history.replaceState(null,null,window.location.pathname))})),window.addEventListener("hashchange",i),i()});